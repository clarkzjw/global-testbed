<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>node.trigger &mdash; LEOScope 00.00.01 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            LEOScope
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Orchestrator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#node">Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#common">Common</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#cli">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#services">Services</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LEOScope</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">node.trigger</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for node.trigger</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">docker</span> 
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">paho.mqtt.client</span> <span class="k">as</span> <span class="nn">mqtt</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">common.trigger</span> <span class="kn">import</span> <span class="n">trigger_get_tree</span><span class="p">,</span> <span class="n">trigger_evaluate_tree</span><span class="p">,</span> <span class="n">trigger_verify</span><span class="p">,</span> <span class="n">trigger_evaluate</span><span class="p">,</span> <span class="n">FIELDS</span>
<span class="kn">from</span> <span class="nn">skyfield.api</span> <span class="kn">import</span> <span class="n">N</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">wgs84</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">EarthSatellite</span>

<span class="kn">import</span> <span class="nn">logging</span> 

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
	<span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> 
	<span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(filename)s</span><span class="s2">:</span><span class="si">%(lineno)s</span><span class="s2"> </span><span class="si">%(thread)d</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Monitor all stats from the terminal gRPC API that can be used for </span>
<span class="sd">trigger based scheduling. Example output from the starlink API command:</span>

<span class="sd">id:                    ut01000000-00000000-001fdb33</span>
<span class="sd">hardware_version:      rev2_proto3</span>
<span class="sd">software_version:      6ac8c726-f096-45a5-9f02-c026b2a65e78.uterm.release</span>
<span class="sd">state:                 CONNECTED</span>
<span class="sd">uptime:                107401</span>
<span class="sd">snr:</span>
<span class="sd">seconds_to_first_nonempty_slot: 0.0</span>
<span class="sd">pop_ping_drop_rate:    0.0</span>
<span class="sd">downlink_throughput_bps: 58082.72265625</span>
<span class="sd">uplink_throughput_bps: 95646.90625</span>
<span class="sd">pop_ping_latency_ms:   27.619047164916992</span>
<span class="sd">Alerts bit field:      0</span>
<span class="sd">fraction_obstructed:   0.0</span>
<span class="sd">currently_obstructed:  False</span>
<span class="sd">seconds_obstructed:</span>
<span class="sd">obstruction_duration:</span>
<span class="sd">obstruction_interval:</span>
<span class="sd">direction_azimuth:     -3.3248794078826904</span>
<span class="sd">direction_elevation:   68.28795623779297</span>
<span class="sd">is_snr_above_noise_floor: True</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LeotestGrpcMonitor"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor">[docs]</a><span class="k">class</span> <span class="nc">LeotestGrpcMonitor</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggerobj</span><span class="p">,</span> <span class="n">dish_id</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;mqtt&#39;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">1883</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">dish_id</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s2">&quot;leotest_grpc&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">on_connect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_connect</span>  
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">on_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_message</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span> <span class="o">=</span> <span class="n">triggerobj</span> 
		<span class="c1"># arm callbacks </span>
	
<div class="viewcode-block" id="LeotestGrpcMonitor.on_connect"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_connect">[docs]</a>	<span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rc</span><span class="p">):</span>  
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connected with result code </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rc</span><span class="p">)))</span> </div>

<div class="viewcode-block" id="LeotestGrpcMonitor.on_message"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_message">[docs]</a>	<span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>   
		<span class="c1"># print(&quot;Message received-&gt; &quot; + msg.topic + &quot; &quot; + str(msg.payload))  </span>

		<span class="c1"># get attributes and the callback</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
		<span class="n">payload</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
		<span class="n">cb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;on_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">cb</span><span class="p">:</span>
			<span class="n">cb</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warn: callback not defined for &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="p">)</span></div>


<div class="viewcode-block" id="LeotestGrpcMonitor.get_topic_status"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.get_topic_status">[docs]</a>	<span class="k">def</span> <span class="nf">get_topic_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
		<span class="k">return</span> <span class="s2">&quot;starlink/dish_status/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="LeotestGrpcMonitor.get_topic_list"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.get_topic_list">[docs]</a>	<span class="k">def</span> <span class="nf">get_topic_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_topic_status</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span></div>

<div class="viewcode-block" id="LeotestGrpcMonitor.arm_callbacks"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.arm_callbacks">[docs]</a>	<span class="k">def</span> <span class="nf">arm_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_topic_list</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeotestGrpcMonitor.run"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.run">[docs]</a>	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_async</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">arm_callbacks</span><span class="p">()</span>

		<span class="k">if</span> <span class="n">run_async</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">loop_start</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">loop_forever</span><span class="p">()</span></div>

	<span class="c1"># &quot;&quot;&quot;callback methods&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LeotestGrpcMonitor.on_downlink_throughput_bps"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_downlink_throughput_bps">[docs]</a>	<span class="k">def</span> <span class="nf">on_downlink_throughput_bps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
		<span class="c1"># print(&#39;field %s payload %s&#39; % (field, payload))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span></div>
	
<div class="viewcode-block" id="LeotestGrpcMonitor.on_uplink_throughput_bps"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_uplink_throughput_bps">[docs]</a>	<span class="k">def</span> <span class="nf">on_uplink_throughput_bps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
		<span class="c1"># print(&#39;field %s payload %s&#39; % (field, payload))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span></div>
	
<div class="viewcode-block" id="LeotestGrpcMonitor.on_pop_ping_latency_ms"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_pop_ping_latency_ms">[docs]</a>	<span class="k">def</span> <span class="nf">on_pop_ping_latency_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
		<span class="c1"># print(&#39;field %s payload %s&#39; % (field, payload))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span></div>

<div class="viewcode-block" id="LeotestGrpcMonitor.on_fraction_obstructed"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_fraction_obstructed">[docs]</a>	<span class="k">def</span> <span class="nf">on_fraction_obstructed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
		<span class="c1"># print(&#39;field %s payload %s&#39; % (field, payload))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></div>

<div class="viewcode-block" id="LeotestGrpcMonitor.on_currently_obstructed"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_currently_obstructed">[docs]</a>	<span class="k">def</span> <span class="nf">on_currently_obstructed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
		<span class="c1"># print(&#39;field %s payload %s&#39; % (field, payload))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></div>
	
<div class="viewcode-block" id="LeotestGrpcMonitor.on_direction_azimuth"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_direction_azimuth">[docs]</a>	<span class="k">def</span> <span class="nf">on_direction_azimuth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
		<span class="c1"># print(&#39;field %s payload %s&#39; % (field, payload))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></div>

<div class="viewcode-block" id="LeotestGrpcMonitor.on_direction_elevation"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestGrpcMonitor.on_direction_elevation">[docs]</a>	<span class="k">def</span> <span class="nf">on_direction_elevation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
		<span class="c1"># print(&#39;field %s payload %s&#39; % (field, payload))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></div></div>

<span class="c1"># class LeotestSatelliteMonitor:</span>
<span class="c1">#     def __init__(self, triggerobj, lat, long, elevation_m, refresh_duration_mins=10):</span>
<span class="c1">#         self.triggerobj = triggerobj</span>
<span class="c1">#         self.lat = lat </span>
<span class="c1">#         self.long = long </span>
<span class="c1">#         self.elevation_m = elevation_m</span>
<span class="c1">#         self.loc = Topos(lat, long, elevation_m=elevation_m)</span>
	
<span class="c1">#     def predict_satellites(self):</span>
<span class="c1">#         sunUp = None</span>
<span class="c1">#         moonUp = None </span>
<span class="c1">#         eclipsed = None </span>
<span class="c1">#         minAlt = 20</span>

<span class="c1">#         params = [sunUp, moonUp, eclipsed, minAlt]</span>
<span class="c1">#         start = dt.datetime.now()</span>
<span class="c1">#         stop = start + dt.timedelta(minutes=10)</span>

<span class="c1">#         passes = starlinkPassPredictor(start, stop, cambridge, params=params, path=&quot;.&quot;, filename=&quot;allPasses&quot;)</span>


<div class="viewcode-block" id="LeotestDockerNetworkMonitor"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestDockerNetworkMonitor">[docs]</a><span class="k">class</span> <span class="nc">LeotestDockerNetworkMonitor</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggerobj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;leotest=true&quot;</span><span class="p">]):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span> <span class="o">=</span> <span class="n">triggerobj</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>


<div class="viewcode-block" id="LeotestDockerNetworkMonitor.get_stats_total"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestDockerNetworkMonitor.get_stats_total">[docs]</a>	<span class="k">def</span> <span class="nf">get_stats_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">container_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
				<span class="n">container_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
					<span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> 
					<span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span> 
				<span class="p">}</span>
				<span class="n">container_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>

		<span class="n">total_tx_bytes</span> <span class="o">=</span> <span class="mi">0</span> 
		<span class="n">total_rx_bytes</span> <span class="o">=</span> <span class="mi">0</span>
		
		<span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">container_list</span><span class="p">:</span>
			<span class="c1"># get stats</span>

			<span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
				
				<span class="k">if</span> <span class="s2">&quot;networks&quot;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">iface</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;networks&quot;</span><span class="p">]:</span>
						<span class="n">total_tx_bytes</span> <span class="o">+=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;networks&quot;</span><span class="p">][</span><span class="n">iface</span><span class="p">][</span><span class="s2">&quot;tx_bytes&quot;</span><span class="p">]</span>
						<span class="n">total_rx_bytes</span> <span class="o">+=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;networks&quot;</span><span class="p">][</span><span class="n">iface</span><span class="p">][</span><span class="s2">&quot;rx_bytes&quot;</span><span class="p">]</span>
				<span class="k">break</span>
		
		<span class="k">return</span> <span class="n">total_tx_bytes</span><span class="p">,</span> <span class="n">total_rx_bytes</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>
	
<div class="viewcode-block" id="LeotestDockerNetworkMonitor.run"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestDockerNetworkMonitor.run">[docs]</a>	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">prev_tx_bytes</span><span class="p">,</span> <span class="n">prev_rx_bytes</span><span class="p">,</span> <span class="n">prev_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats_total</span><span class="p">()</span>

		<span class="k">while</span> <span class="kc">True</span><span class="p">:</span> 
			<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">tx_bytes</span><span class="p">,</span> <span class="n">rx_bytes</span><span class="p">,</span> <span class="n">curr_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats_total</span><span class="p">()</span>

			<span class="n">tx_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">tx_bytes</span> <span class="o">-</span> <span class="n">prev_tx_bytes</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">prev_time</span><span class="p">))</span>
			<span class="n">rx_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">rx_bytes</span> <span class="o">-</span> <span class="n">prev_rx_bytes</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">prev_time</span><span class="p">))</span>

			<span class="n">prev_tx_bytes</span><span class="p">,</span> <span class="n">prev_rx_bytes</span><span class="p">,</span> <span class="n">prev_time</span> <span class="o">=</span> <span class="n">tx_bytes</span><span class="p">,</span> <span class="n">rx_bytes</span><span class="p">,</span> <span class="n">curr_time</span>

			<span class="c1"># print(&#39;experiment tx_rate=%d bytes/sec rx_rate=%d bytes/sec &#39; % (tx_rate, rx_rate))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;exp_tx_rate_bytes&#39;</span><span class="p">,</span> <span class="n">tx_rate</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;exp_rx_rate_bytes&#39;</span><span class="p">,</span> <span class="n">rx_rate</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="LeotestDockerNetworkMonitor.run_async"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestDockerNetworkMonitor.run_async">[docs]</a>	<span class="k">def</span> <span class="nf">run_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
		<span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="LeotestSatelliteMonitor"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestSatelliteMonitor">[docs]</a><span class="k">class</span> <span class="nc">LeotestSatelliteMonitor</span><span class="p">:</span>

	<span class="n">MAX_SATELLITE_DISTANCE</span> <span class="o">=</span> <span class="mf">1089686.4181956202</span>
	
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggerobj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">ele</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span> <span class="o">=</span> <span class="n">triggerobj</span> 

		<span class="bp">self</span><span class="o">.</span><span class="n">gs</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
				<span class="s2">&quot;latitude_degrees_str&quot;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span>
				<span class="s2">&quot;longitude_degrees_str&quot;</span><span class="p">:</span> <span class="n">lon</span><span class="p">,</span>
				<span class="s2">&quot;elevation_m_float&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ele</span><span class="p">),</span>
			<span class="p">}</span>
	
<div class="viewcode-block" id="LeotestSatelliteMonitor.extract_starlink_shells"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestSatelliteMonitor.extract_starlink_shells">[docs]</a>	<span class="k">def</span> <span class="nf">extract_starlink_shells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tle_filename</span><span class="p">,</span> <span class="n">satelliteName</span><span class="p">):</span>
		<span class="n">tle_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tle_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
		<span class="n">Lines</span> <span class="o">=</span> <span class="n">tle_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Lines</span><span class="p">),</span><span class="mi">3</span><span class="p">):</span>
			<span class="n">tle_first_line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">satelliteName</span> <span class="o">==</span> <span class="n">tle_first_line</span><span class="p">:</span>
				<span class="n">tle_second_line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)))</span>

				<span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">53.2</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">53</span><span class="p">:</span> <span class="c1">#Inclination of Starlink shell 1 should be 53.0 degrees</span>
					<span class="k">return</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">53.5</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mf">53.2</span><span class="p">:</span> <span class="c1">#Inclination of Starlink shell 4 should be 53.2 degrees</span>
					<span class="k">return</span> <span class="mi">4</span>
				<span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">71</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span> <span class="c1">#Inclination of Starlink shell 2 should be 70.0 degrees</span>
					<span class="k">return</span> <span class="mi">2</span>
				<span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">97.9</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">tle_second_line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mf">97.6</span><span class="p">:</span> <span class="c1">#Inclination of Starlink shell 3 and 5 should be 97.6 degrees</span>
					<span class="k">return</span> <span class="mi">3</span>
		<span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="LeotestSatelliteMonitor.distance_between_ground_station_satellite"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestSatelliteMonitor.distance_between_ground_station_satellite">[docs]</a>	<span class="k">def</span> <span class="nf">distance_between_ground_station_satellite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_station</span><span class="p">,</span> <span class="n">satellite</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
		<span class="n">bluffton</span> <span class="o">=</span> <span class="n">wgs84</span><span class="o">.</span><span class="n">latlon</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ground_station</span><span class="p">[</span><span class="s2">&quot;latitude_degrees_str&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">ground_station</span><span class="p">[</span><span class="s2">&quot;longitude_degrees_str&quot;</span><span class="p">]),</span> <span class="n">ground_station</span><span class="p">[</span><span class="s2">&quot;elevation_m_float&quot;</span><span class="p">])</span>
		<span class="n">geocentric</span> <span class="o">=</span> <span class="n">satellite</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
		<span class="n">difference</span> <span class="o">=</span> <span class="n">satellite</span> <span class="o">-</span> <span class="n">bluffton</span>
		<span class="n">topocentric</span> <span class="o">=</span> <span class="n">difference</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

		<span class="n">alt</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">topocentric</span><span class="o">.</span><span class="n">altaz</span><span class="p">()</span>

		<span class="c1"># return distance.m</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">az</span><span class="p">,</span><span class="n">distance</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeotestSatelliteMonitor.constellation_updates"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestSatelliteMonitor.constellation_updates">[docs]</a>	<span class="k">def</span> <span class="nf">constellation_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tle_url</span><span class="p">,</span> <span class="n">ground_stations</span><span class="p">,</span> <span class="n">running_time</span><span class="p">):</span>
		<span class="n">satellites</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">tle_file</span><span class="p">(</span><span class="n">tle_url</span><span class="p">)</span>
		<span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">dists</span> <span class="o">=</span> <span class="p">[]</span>

		<span class="k">for</span> <span class="n">gs</span> <span class="ow">in</span> <span class="n">ground_stations</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">sat</span> <span class="ow">in</span> <span class="n">satellites</span><span class="p">:</span>
				<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_between_ground_station_satellite</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">sat</span><span class="p">,</span> <span class="n">running_time</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SATELLITE_DISTANCE</span><span class="p">:</span>
					<span class="n">shellnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_starlink_shells</span><span class="p">(</span><span class="s2">&quot;./starlink.txt&quot;</span><span class="p">,</span> <span class="n">sat</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
					<span class="n">dt</span><span class="p">,</span> <span class="n">leap_second</span> <span class="o">=</span> <span class="n">running_time</span><span class="o">.</span><span class="n">utc_datetime_and_leap_second</span><span class="p">()</span>
					<span class="n">newscs</span> <span class="o">=</span> <span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">date</span><span class="p">,</span> <span class="n">timeN</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="n">running_time</span><span class="o">.</span><span class="n">utc_strftime</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
					<span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
					<span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">timeN</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
					<span class="n">loggedTime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minute</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">newscs</span><span class="p">)</span>
					<span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">loggedTime</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">gs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">sat</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">shellnum</span><span class="p">])</span>
					<span class="n">dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

		<span class="n">a</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">temp_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="c1"># for aa in a:</span>
		<span class="c1">#     print(aa)</span>

		<span class="n">max_dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
		<span class="n">min_dist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
		<span class="n">mean_dist</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
		<span class="c1"># print(&#39;distance max=%d min=%d mean=%d&#39; % (max_dist, min_dist, mean_dist))</span>
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[satellite debug] &#39;</span> 
	   			<span class="s1">&#39;updating satellite distance: max=</span><span class="si">%s</span><span class="s1"> min=</span><span class="si">%s</span><span class="s1"> mean=</span><span class="si">%s</span><span class="s1">&#39;</span> 
	   			<span class="o">%</span> <span class="p">(</span><span class="n">max_dist</span><span class="p">,</span> <span class="n">min_dist</span><span class="p">,</span> <span class="n">mean_dist</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;sat_dist_max&#39;</span><span class="p">,</span> <span class="n">max_dist</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;sat_dist_min&#39;</span><span class="p">,</span> <span class="n">min_dist</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;sat_dist_mean&#39;</span><span class="p">,</span> <span class="n">mean_dist</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeotestSatelliteMonitor.run"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestSatelliteMonitor.run">[docs]</a>	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># print(&quot;run this main ..&quot;)</span>
		<span class="n">ts</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">timescale</span><span class="p">()</span>
		<span class="n">actual_time</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
		<span class="c1"># print(actual_time.utc_strftime())</span>

		<span class="n">ground_stations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gs</span><span class="p">]</span>
		<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[satellite debug] entering while loop&#39;</span><span class="p">)</span>
			<span class="n">pydate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">utc</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pydate</span><span class="o">.</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pydate</span><span class="o">.</span><span class="n">month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pydate</span><span class="o">.</span><span class="n">day</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pydate</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pydate</span><span class="o">.</span><span class="n">minute</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pydate</span><span class="o">.</span><span class="n">second</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">constellation_updates</span><span class="p">(</span><span class="s2">&quot;https://celestrak.org/NORAD/elements/supplemental/starlink.txt&quot;</span><span class="p">,</span> <span class="n">ground_stations</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
			<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="LeotestSatelliteMonitor.run_async"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestSatelliteMonitor.run_async">[docs]</a>	<span class="k">def</span> <span class="nf">run_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
		<span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div></div>
				

<div class="viewcode-block" id="LeotestWeatherMonitor"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestWeatherMonitor">[docs]</a><span class="k">class</span> <span class="nc">LeotestWeatherMonitor</span><span class="p">:</span>
	
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggerobj</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span> <span class="o">=</span> <span class="n">triggerobj</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>
	
<div class="viewcode-block" id="LeotestWeatherMonitor.run"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestWeatherMonitor.run">[docs]</a>	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

		<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
			<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

			<span class="k">if</span> <span class="s1">&#39;weather&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="n">w</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weather&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_id&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_main&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_desc&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			

			<span class="k">if</span> <span class="s1">&#39;main&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_temp&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>	
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_pressure&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>	
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_humidity&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;humidity&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_temp_min&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temp_min&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_temp_max&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temp_max&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			
			<span class="k">if</span> <span class="s1">&#39;clouds&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_clouds&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;clouds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			
			<span class="k">if</span> <span class="s1">&#39;rain&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_rain1h&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_rain3h&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;3h&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			
			<span class="k">if</span> <span class="s1">&#39;snow&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_snow1h&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;snow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_snow3h&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;snow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;3h&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			
			<span class="k">if</span> <span class="s1">&#39;visibility&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_visibility&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">])</span>
			
			<span class="k">if</span> <span class="s1">&#39;wind&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_speed&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;speed&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_deg&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">triggerobj</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="s1">&#39;weather_gust&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gust&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

			<span class="c1"># query weather data every 30mins. </span>
			<span class="c1"># TODO: Make this configurable </span>
			<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1800</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeotestWeatherMonitor.run_async"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestWeatherMonitor.run_async">[docs]</a>	<span class="k">def</span> <span class="nf">run_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
		<span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Initialize trigger mode </span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="LeotestTriggerMode"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode">[docs]</a><span class="k">class</span> <span class="nc">LeotestTriggerMode</span><span class="p">:</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">FIELDS</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mqtt_hostname</span><span class="o">=</span><span class="s1">&#39;mqtt&#39;</span><span class="p">,</span> <span class="n">mqtt_port</span><span class="o">=</span><span class="mi">1883</span><span class="p">,</span>
					<span class="n">redis_hostname</span><span class="o">=</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="n">redis_port</span><span class="o">=</span><span class="mi">6379</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;init&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">trigger_trees</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span>

		<span class="c1"># if not verify:</span>
		<span class="c1"># 	for trigger in self.triggers:</span>
		<span class="c1"># 		self.trigger_trees[trigger] = trigger_get_tree(trigger)</span>
		<span class="c1"># 		print(self.trigger_trees[trigger])</span>
		
		<span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_avg&quot;</span> <span class="o">%</span> <span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">history</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
		
		<span class="c1"># init queue </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span> <span class="o">=</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s2">&quot;leotest_trigger&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">on_connect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_queue_connect</span>  
		<span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">on_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_queue_message</span>

		<span class="c1"># connect with the queue </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mqtt_hostname</span><span class="p">,</span> <span class="n">mqtt_port</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">loop_start</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_hostname</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">redis_port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	
<div class="viewcode-block" id="LeotestTriggerMode.on_queue_connect"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.on_queue_connect">[docs]</a>	<span class="k">def</span> <span class="nf">on_queue_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rc</span><span class="p">):</span>  
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connected with result code </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rc</span><span class="p">)))</span> </div>

<div class="viewcode-block" id="LeotestTriggerMode.on_queue_message"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.on_queue_message">[docs]</a>	<span class="k">def</span> <span class="nf">on_queue_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>   
		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message received-&gt; &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">topic</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">payload</span><span class="p">))</span>  </div>
	
<div class="viewcode-block" id="LeotestTriggerMode.sync_triggers"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.sync_triggers">[docs]</a>	<span class="k">def</span> <span class="nf">sync_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_job_list</span><span class="p">,</span> <span class="n">ttl_secs</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;sync jobs from a remote job list&quot;&quot;&quot;</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
		<span class="n">pipe</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">remote_job_list</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="n">pipe</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">get_jobid</span><span class="p">())</span>
			<span class="c1"># ttl = datetime.now() + timedelta(seconds=30)</span>
			<span class="n">ttl</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">length_secs</span> <span class="o">+</span> <span class="n">ttl_secs</span>
			<span class="n">pipe</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">get_jobid</span><span class="p">(),</span> <span class="n">job</span><span class="o">.</span><span class="n">get_trigger</span><span class="p">(),</span> <span class="n">ex</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">ttl</span><span class="p">))</span>
			<span class="c1"># pipe.expire(name=jobid, time=ttl)</span>

		<span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span></div>

<div class="viewcode-block" id="LeotestTriggerMode.get_all_triggers"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.get_all_triggers">[docs]</a>	<span class="k">def</span> <span class="nf">get_all_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;fetch a list of all triggers currently active&quot;&quot;&quot;</span>
		<span class="n">triggers</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lrange</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="c1"># print(ret) </span>
		<span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
			<span class="n">jobid</span> <span class="o">=</span> <span class="n">jobid</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
				<span class="n">triggers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">jobid</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
		
		<span class="k">return</span> <span class="n">triggers</span></div>
	
<div class="viewcode-block" id="LeotestTriggerMode.remove_trigger"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.remove_trigger">[docs]</a>	<span class="k">def</span> <span class="nf">remove_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;remove trigger&quot;&quot;&quot;</span></div>
	
<div class="viewcode-block" id="LeotestTriggerMode.refresh_trigger"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.refresh_trigger">[docs]</a>	<span class="k">def</span> <span class="nf">refresh_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;refresh trigger expiry&quot;&quot;&quot;</span></div>
	
	
<div class="viewcode-block" id="LeotestTriggerMode.evaluate_triggers"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.evaluate_triggers">[docs]</a>	<span class="k">def</span> <span class="nf">evaluate_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;evaluate here&quot;&quot;&quot;</span>

		<span class="k">for</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_triggers</span><span class="p">():</span>
			<span class="n">ret</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trigger_evaluate</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;leotest/triggers/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jobid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span></div>
			<span class="c1"># print(&quot;Trigger=&#39;%s&#39; eval=&#39;%s&#39;&quot; % (trigger, ret))</span>
	
<div class="viewcode-block" id="LeotestTriggerMode.verify_triggers"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.verify_triggers">[docs]</a>	<span class="k">def</span> <span class="nf">verify_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;verify triggers&quot;&quot;&quot;</span>

		<span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">:</span>
			<span class="n">ret</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">trigger_verify</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
			
			<span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
				<span class="n">success</span> <span class="o">=</span> <span class="kc">False</span> 
				<span class="n">err_msg</span> <span class="o">=</span> <span class="n">msg</span>
				<span class="k">break</span> 
		
		<span class="k">return</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s1">&#39;trigger: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err_msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeotestTriggerMode.update_field"><a class="viewcode-back" href="../../node.html#node.trigger.LeotestTriggerMode.update_field">[docs]</a>	<span class="k">def</span> <span class="nf">update_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
		
		<span class="c1"># update history </span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_1&quot;</span> <span class="o">%</span> <span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

		<span class="nb">sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
				<span class="nb">sum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
		
			<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_avg&quot;</span> <span class="o">%</span> <span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">evaluate_triggers</span><span class="p">()</span></div></div>


<span class="c1"># triggers = [&quot;(uplink_throughput_bps - exp_tx_rate_bytes*8 &gt; 100000) &amp; (downlink_throughput_bps - exp_rx_rate_bytes*8 &gt; 40000)&quot;]</span>

<span class="c1"># triggers = [&quot;|pop_ping_latency_ms_1 - pop_ping_latency_ms| / pop_ping_latency_ms_1 * 100 &gt; 60&quot;]</span>

<span class="c1"># trigger = LeotestTriggerMode(fields=[&#39;uplink_throughput_bps&#39;, </span>
<span class="c1"># 									&#39;downlink_throughput_bps&#39;, </span>
<span class="c1"># 									&#39;exp_tx_rate_bytes&#39;, </span>
<span class="c1"># 									&#39;exp_rx_rate_bytes&#39;,</span>
<span class="c1"># 									&#39;pop_ping_latency_ms&#39;,</span>
<span class="c1"># 									&#39;direction_azimuth&#39;,</span>
<span class="c1"># 									&#39;direction_elevation&#39;,</span>
<span class="c1"># 									&#39;currently_obstructed&#39;,</span>
<span class="c1"># 									&#39;fraction_obstructed&#39;],</span>
<span class="c1"># 							triggers = triggers)</span>

<span class="c1"># grpcmon = LeotestGrpcMonitor(trigger, &quot;ut01000000-00000000-001fdb33&quot;, </span>
<span class="c1"># 				fields=[&#39;uplink_throughput_bps&#39;, </span>
<span class="c1"># 						&#39;downlink_throughput_bps&#39;, </span>
<span class="c1"># 						&#39;pop_ping_latency_ms&#39;,</span>
<span class="c1"># 						&#39;direction_azimuth&#39;,</span>
<span class="c1"># 						&#39;direction_elevation&#39;,</span>
<span class="c1"># 						&#39;currently_obstructed&#39;,</span>
<span class="c1"># 						&#39;fraction_obstructed&#39;])</span>

<span class="c1"># dockermon = LeotestDockerNetworkMonitor(trigger)</span>

<span class="c1"># grpcmon.run(run_async=True)</span>
<span class="c1"># dockermon.run()</span>
<span class="c1"># subscribe.callback(on_message_print, [&quot;starlink/dish_status/ut01000000-00000000-001fdb33/uplink_throughput_bps&quot;], hostname=&quot;localhost&quot;)</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Shubham Tiwari, Aryan Taneja, Saksham Bhushan, M. Kassem, Nishanth Sastry, Aravindh Raman, Debopam Bhattacherjee.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>